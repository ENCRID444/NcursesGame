#include <curses.h>
#include <cstdlib>
#include <ctime>
#include <fstream>
#include <string>

using namespace std;


//variabel global untuk skor
int skorTertinggi = 0;

//fungsi untuk memuat skor dari file
void muatSkorTertinggi(){
    ifstream file("flappy_score.txt");
    if (file.is_open()){
        file >> skorTertinggi;
        file.close();
    }
}

//fungsi untuk menyimpan skor tertinggi 
void simpanSkorTertinggi(int skor){
    if (skor > skor Tertinggi){
        skorTertinggi = skor;
        ofstream file("flappy_score.txt");
        if (file.is_open()){
            file << skorTertinggi;
            file.close();
        }
    }
}

//fungsi untuk menampilkan menu awal
void menuAwal(){
    clear();

    //untuk posisi tengah di ukuran layar
    int tinggi, lebar;
    getmaxyx(stdscr, tinggi, lebar);

    //untuk menghitung posisi tengah 
    int tengah = lebar/2;

    //untuk menampilkan judul game
    mvprintw(5, tengah-10, "=========================");
    mvprintw(6, tengah-10, "      FLAPPY BIRD        ");
    mvprintw(7, tengah-10, "=========================");

    //menampilkan skor tertinggi di bagian atas
    mvprintw(2, 5, "SKOR TERTINGGI: %d", skorTertinggi);

    //menampilkkan perintah game
    

// Fungsi utama game Flappy Bird
void mulaiPermainan() {
    // ===== ATUR MODE GAME =====
    nodelay(stdscr, TRUE);   // Input non-blocking
    keypad(stdscr, TRUE);    // Aktifkan special keys
    curs_set(0);            // Sembunyikan kursor
    
    // ===== DAPATKAN UKURAN LAYAR =====
    int tinggi, lebar;
    getmaxyx(stdscr, tinggi, lebar);
    
    // ===== VARIABEL GAME =====
    int burungY = tinggi / 2;
    int burungX = 20;
    float kecepatan = 0.0f;
    
    // Pipa dengan posisi random
    int pipa1X = lebar / 2;
    int pipa1GapY = rand() % (tinggi - 25) + 10;
    
    int pipa2X = lebar;
    int pipa2GapY = rand() % (tinggi - 25) + 10;
    
    int skor = 0;
    bool gameBerjalan = true;
    
    // ===== SETTING GAME =====
    const float GRAVITASI = 0.4f;
    const float LOMPAT = -3.0f;
    const int CELAH = 15;
    
    // ===== COUNTDOWN SEBELUM MULAI =====
    clear();
    
    // Tampilkan skor tertinggi di layar countdown
    mvprintw(tinggi/2 - 3, lebar/2 - 10, "SKOR TERTINGGI: %d", skorTertinggi);
    mvprintw(tinggi/2 - 1, lebar/2 - 10, "SIAP...");
    refresh();
    napms(1000);
    
    mvprintw(tinggi/2 - 1, lebar/2 - 5, "MULAI!");
    refresh();
    napms(500);
    
    // ===== GAME LOOP =====
    while(gameBerjalan) {
        clear();
        
        // Gambar tanah
        for(int x = 0; x < lebar; x++) {
            mvprintw(tinggi - 2, x, "=");
        }
        
        // Input
        int ch = getch();
        if(ch == ' ') {
            kecepatan = LOMPAT;
        } else if(ch == 27) { // ESC untuk keluar
            gameBerjalan = false;
            // Simpan skor jika keluar manual
            if(skor > 0) {
                simpanSkorTertinggi(skor);
            }
            break;
        }
        
        // Update burung
        kecepatan += GRAVITASI;
        burungY += (int)kecepatan;
        
        // Batasan layar
        if(burungY < 1) {
            burungY = 1;
            kecepatan = 0;
        }
        if(burungY >= tinggi - 3) {
            gameBerjalan = false;
        }
        
        // Update dan gambar pipa 1
        pipa1X--;
        if(pipa1X < 0) {
            pipa1X = lebar;
            pipa1GapY = 10 + rand() % (tinggi - CELAH - 20);
            skor++;
        }
        
        for(int y = 0; y < pipa1GapY; y++) {
            mvprintw(y, pipa1X, "|");
        }
        for(int y = pipa1GapY + CELAH; y < tinggi - 2; y++) {
            mvprintw(y, pipa1X, "|");
        }
        
        // Update dan gambar pipa 2
        pipa2X--;
        if(pipa2X < 0) {
            pipa2X = lebar;
            pipa2GapY = 10 + rand() % (tinggi - CELAH - 20);
            skor++;
        }
        
        for(int y = 0; y < pipa2GapY; y++) {
            mvprintw(y, pipa2X, "|");
        }
        for(int y = pipa2GapY + CELAH; y < tinggi - 2; y++) {
            mvprintw(y, pipa2X, "|");
        }
        
        // Gambar burung
        mvprintw(burungY, burungX, ">O");
        
        // Cek tabrakan
        if((pipa1X == burungX || pipa1X + 1 == burungX) &&
           (burungY < pipa1GapY || burungY > pipa1GapY + CELAH)) {
            gameBerjalan = false;
        }
        
        if((pipa2X == burungX || pipa2X + 1 == burungX) &&
           (burungY < pipa2GapY || burungY > pipa2GapY + CELAH)) {
            gameBerjalan = false;
        }
        
        // Info game (tampilkan skor tertinggi dan skor saat ini)
        mvprintw(1, 2, "SKOR: %d", skor);
        mvprintw(2, 2, "TERTINGGI: %d", skorTertinggi);
        mvprintw(3, 2, "SPASI: Lompat  ESC: Keluar");
        
        refresh();
        napms(70);
    }
    
    // ===== GAME OVER =====
    nodelay(stdscr, FALSE);  // Kembali ke blocking mode
    
    // Simpan skor jika lebih tinggi
    simpanSkorTertinggi(skor);
    
    // Muat ulang skor tertinggi
    muatSkorTertinggi();
    
    clear();

    // Tampilkan hasil permainan
    mvprintw(tinggi/2 - 5, lebar/2 - 15, "==============================");
    mvprintw(tinggi/2 - 4, lebar/2 - 15, "         GAME OVER           ");
    mvprintw(tinggi/2 - 3, lebar/2 - 15, "==============================");
    
    // Tampilkan skor saat ini
    mvprintw(tinggi/2 - 1, lebar/2 - 15, "Skor Anda:           %d", skor);
    
    // Tampilkan skor tertinggi (setelah mungkin diperbarui)
    mvprintw(tinggi/2 + 1, lebar/2 - 15, "Skor Tertinggi:      %d", skorTertinggi);
    
    // Beri pesan khusus berdasarkan skor
    mvprintw(tinggi/2 + 3, lebar/2 - 15, "PESAN Atmin:");
    if(skor == 0) {
        mvprintw(tinggi/2 + 4, lebar/2 - 15, "Pencet SPASI Kocak");
    } else if(skor < 5) {
        mvprintw(tinggi/2 + 4, lebar/2 - 15, "Masih Kroco sih");
    } else if(skor < 10) {
        mvprintw(tinggi/2 + 4, lebar/2 - 15, "Gelok");
    } else if(skor < 20) {
        mvprintw(tinggi/2 + 4, lebar/2 - 15, "Gacor Ketua");
    } else {
        mvprintw(tinggi/2 + 4, lebar/2 - 15, "Ampun puhh");
    }
    
    // Cek apakah memecahkan rekor
    if(skor == skorTertinggi && skor > 0) {
        mvprintw(tinggi/2 + 6, lebar/2 - 20, "REKOR BARU TERCIPTA!");
    }
    
    mvprintw(tinggi/2 + 8, lebar/2 - 15, "Pencet basing untuk balik ke menu");
    
    refresh();
    getch();
    
    // Kembali ke menu
    curs_set(1);
}


